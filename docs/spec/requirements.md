# Lucid - 要件定義

## ビジョン

**「AIの中で暮らすOS」** — チャットではなく、共在する。

AIエージェントがコモディティ化した世界で、差別化はUIにしかない。
Lucidは明晰夢のように「AIの中にいることを自覚しながら自然に暮らせる」環境を提供する。

### 設計原則: 認知負荷の最小化

全UIは「ユーザーの注意を奪わない」ことを最優先とする。
情報密度は文脈に応じて動的に調整され、必要なものだけが必要な時に現れる。

---

## 3つのパラダイムシフト

### 1. チャット欄を殺す → 共有キャンバス

| 従来 | Lucid |
|------|-------|
| 指示 → 応答のターンベース | 共同作業中にAIが自律的に動く |
| メッセージが情報の単位 | キャンバス上のオブジェクトが情報の単位 |
| 会話履歴をスクロール | 空間的にナビゲーション |
| 1対1の対話 | 多対多の共在（人間+AI+AI） |

キャンバスは**自律エージェントの容器**であり、人間同士のコミュニケーション空間でもある。
- テキストチャット → キャンバス上のアノテーション
- 「送信」ボタン → 同じ空間にいるだけで共有
- 既読/未読 → 存在感・注目度のグラデーション

### 2. エージェントは「相手」ではなく「環境」

| 従来 | Lucid |
|------|-------|
| プロンプトを書く | 行動するだけ |
| AIに「指示」する | AIが「察する」|
| 明示的なコマンド | 面積分的な意図推論 |
| エージェント選択 | コンテキストに応じて自動切替 |

**面積分的意図推論**:
- ユーザーの連続的な行動（クリック、スクロール、タイピング、停止）を時間軸で統合
- 単一の行動ではなく、行動の「面積」から意図を推定
- 例: ドキュメントを3回読み返す + 特定箇所で停止 → 「ここが理解できていない」と推論

### 3. 信頼のグラデーション設計

| 従来 | Lucid |
|------|-------|
| 許可 / 拒否の二値 | 信頼度0〜100のスペクトラム |
| 全データ見えるor見えない | 信頼度に応じて情報が有機的に流れる |
| 権限はユーザーが手動設定 | 行動履歴から信頼度が自動調整 |
| セキュリティ = 壁 | セキュリティ = 膜（浸透圧）|

信頼度はLucidの**統一制御原理**であり、以下の全てを支配する:

| 制御対象 | 信頼度低（0-20） | 信頼度高（80-100） |
|---------|-----------------|-------------------|
| **情報アクセス** | 基本情報のみ | 個人データも自然に流れる |
| **自律的アクション** | 全て要承認 | 承認不要で自律行動 |
| **経済活動** | ¥100/日、¥10/回上限、全て要承認 | ¥100,000/日、¥10,000/回、自動決済 |
| **グループ参加** | 公開グループのみ | プライベートグループも参加可能 |
| **残高枯渇時** | 即時停止、オーナーに通知 | 観察モードに移行、オーナーに通知 |

**信頼度の対象**: 現在はエージェントのみ。オーナー（人間）がエージェントごとに設定・自動調整する。
将来的にユーザー間の信頼度（コラボレーター信頼）も導入予定。

ユーザーは信頼度を明示的に上げ下げ可能。行動履歴に基づく自動調整も行われる。

---

## 機能要件

### A. 共有キャンバス

キャンバスはLucidの**場**であり、全ての活動がここで行われる。

| 機能 | 説明 | 優先度 |
|------|------|--------|
| リアルタイム共同編集 | CRDT（Yjs）ベースの共有状態 | P0 |
| オブジェクト配置 | テキスト/画像/コード/ファイルをキャンバスに配置 | P0 |
| 空間ナビゲーション | ズーム/パン/ミニマップ | P0 |
| カーソル共有 | 他ユーザー・AIの作業位置をリアルタイム表示 | P1 |
| テンプレート | プロジェクト管理/ブレスト/ドキュメント等の初期レイアウト | P2 |

**キャンバス上のシステムUI**（全てオブジェクトとして空間的に配置）:
- ウォレットウィジェット（残高・利用状況）
- 承認カード（エージェントの決済・アクション承認リクエスト）
- 存在感インジケータ（誰がどこを見ているか）
- アノテーション（コメント・リアクション）
- 通知バブル（メンション・重要な変更）

### B. 環境型エージェント

エージェントは「呼び出す相手」ではなく「場に溶け込んだ環境」として振る舞う。

| 機能 | 説明 | 優先度 |
|------|------|--------|
| 行動トラッキング | ユーザーの操作を非侵襲的に収集 | P0 |
| 意図推論エンジン | 面積分的に行動を統合→意図を推定 | P0 |
| 自律的アクション | 推論結果に基づきキャンバスに提案を配置 | P0 |
| コンテキスト切替 | 作業内容に応じてエージェントの専門性が動的に変化 | P1 |
| 学習・適応 | ユーザーの承認/却下フィードバックで精度向上 | P1 |

エージェントの行動範囲は**信頼度**によって制御される（情報アクセス・自律行動・経済活動の全て）。

### C. 信頼グラデーション

信頼度は**情報・行動・経済**を統一的に制御するLucidの核心メカニズム。

| 機能 | 説明 | 優先度 |
|------|------|--------|
| 信頼度スコア | エンティティ（人間・エージェント）ごとの信頼度数値管理 | P0 |
| 情報フィルタリング | 信頼度に応じたデータアクセス範囲の自動調整 | P0 |
| 経済権限制御 | 信頼度に応じた決済上限・承認要否の自動設定 | P1 |
| 信頼度UI | 直感的な信頼度の確認・手動調整 | P1 |
| グループセキュリティ | 信頼度に基づくグループ参加・情報共有範囲の制御 | P1 |
| 信頼度履歴 | 信頼度変動の可視化とレビュー | P2 |
| 自動調整 | 行動履歴・フィードバックからの信頼度自動更新 | P2 |

### D. 共通経済レイヤー

人間とエージェントが**同一の経済システム**で活動する。信頼グラデーションの経済的表現。

| 機能 | 説明 | 優先度 |
|------|------|--------|
| ウォレット | 各エンティティ（人間・エージェント）がJPY建て残高を保持 | P1 |
| コスト透明化 | エージェントの全アクションにコストを表示（認知負荷に配慮した動的表示） | P1 |
| 承認フロー | 信頼度上限を超えた決済はキャンバス上に承認カードとして表示 | P1 |
| 入金 | Stripe Checkout経由でウォレットにチャージ | P1 |
| 資金配分 | 人間がエージェントのウォレットに資金を配分 | P1 |
| 利用履歴 | 取引履歴の閲覧・分析 | P2 |

> 詳細設計: [payment-layer.md](./payment-layer.md)

### E. 人間コミュニケーション

チャットは消えるのではなく、キャンバス上のインタラクションに**変容**する。

| 機能 | 説明 | 優先度 |
|------|------|--------|
| アノテーション | キャンバス上の任意位置にコメント | P0 |
| 存在感表示 | 誰がどこを見ているかのリアルタイム表示 | P1 |
| 通知 | 重要な変更・メンションの通知 | P1 |
| リアクション | オブジェクトへの絵文字リアクション | P2 |
| DM（フォールバック） | 従来型テキストチャット（必要時のみ） | P2 |

---

## 技術アーキテクチャ

### 統一データモデル

```
Canvas（場）
├── Objects（情報の単位）
│   ├── content objects    -- テキスト/画像/コード/ファイル
│   ├── system objects     -- ウォレットUI/承認カード/通知
│   └── annotation objects -- コメント/リアクション
├── Presence（存在感）
│   ├── cursor positions   -- カーソル位置
│   └── attention map      -- 注目度ヒートマップ
├── Trust（信頼制御）
│   ├── trust scores       -- エンティティごとの信頼度
│   ├── access rules       -- 情報アクセスルール
│   └── spending rules     -- 経済活動ルール
└── Economy（経済）
    ├── wallets            -- エンティティごとの残高
    └── transactions       -- 取引履歴
```

### 技術スタック

| レイヤー | 技術 | 理由 |
|---------|------|------|
| フロントエンド | Next.js 15 + React + Tailwind + shadcn/ui | Hiveからの資産継続 |
| キャンバス | tldraw or Excalidraw | OSS共同編集キャンバス |
| リアルタイム同期 | Yjs + WebSocket | CRDTベースのコンフリクトフリー同期 |
| 永続化 | Supabase（PostgreSQL + Auth + Storage） | 認証・ストレージ・DB統合 |
| 決済 | Stripe（Checkout + Connect） | 入金・決済インフラ |
| AI推論 | ローカル or クラウドLLM | コモディティ前提で柔軟に |
| 行動トラッキング | カスタム（イベントバス） | フロントエンドでの行動収集 |
| 信頼エンジン | カスタム（ルールベース→ML） | 段階的に高度化 |

### Hiveからの移行パス

| Hiveの資産 | Lucidでの扱い |
|-----------|--------------|
| Supabase Auth | そのまま利用 |
| events テーブル | CRDTオブジェクトに変換 |
| rooms | キャンバス（canvas）に対応 |
| agents テーブル | 環境型エージェント + ウォレットに拡張 |
| UI コンポーネント | 基盤（shadcn/ui）は再利用 |

---

## 非機能要件

| 項目 | 要件 |
|------|------|
| リアルタイム性 | 操作反映 < 50ms（ローカル）、< 200ms（リモート） |
| オフライン | CRDTによりオフライン編集→再接続時に自動マージ |
| 認知負荷 | UIの情報密度を動的に調整、ユーザーの注意を奪わない設計 |
| プライバシー | 行動データはローカル処理優先、クラウドは匿名化 |
| 決済安全性 | レジャー型（JPY建て内部残高）で法規制リスク回避 |
| スケーラビリティ | キャンバスあたり100+オブジェクト、10+同時接続 |

---

## マイルストーン

| フェーズ | 内容 | 目標 |
|---------|------|------|
| α | 共有キャンバス + リアルタイム同期 + ウォレットDB | 基盤構築 |
| β | 環境型エージェント + 信頼度連動 + 承認フロー | コアUX検証 |
| γ | 信頼グラデーション完成 + Stripe入金 + 人間コミュニケーション | 完成度向上 |
| 1.0 | Hiveユーザー移行 + パブリックリリース | ローンチ |
