# Lucid - 要件定義

## ビジョン

**「AIの中で暮らすOS」** — チャットではなく、共在する。

AIエージェントがコモディティ化した世界で、差別化はUIにしかない。
Lucidは明晰夢のように「AIの中にいることを自覚しながら自然に暮らせる」環境を提供する。

### 設計原則: 認知負荷の最小化

全UIは「ユーザーの注意を奪わない」ことを最優先とする。
情報密度は文脈に応じて動的に調整され、必要なものだけが必要な時に現れる。

---

## 3つのパラダイムシフト

### 1. チャット欄を殺す → ページ型キャンバス

| 従来（チャット） | Lucid（ページ型キャンバス） |
|-----------------|---------------------------|
| メッセージが情報の単位 | **A4サイズのページ**が情報の単位 |
| 会話は一方向にスクロール | ページ内を自由に編集、満杯で次ページへ |
| 送信 → 既読の線形フロー | ページ上で共同編集、リアルタイム共在 |
| 1対1の対話 | 多対多の共在（人間+AI+AI） |

**ページ型キャンバスとは**:
- A4サイズ1枚のテキスト編集空間が基本単位
- 人間同士はページ内に自由にテキストを入力して会話する
- ページがいっぱいになると、自動的に次のページに遷移（アイコン出現）
- 1ページ ≒ 1つの会話セッション（文脈のまとまり）
- ページの連なりが会話の履歴になる

**チャットとの本質的な違い**:
- チャット: 「送る」行為が基本（非同期メッセージング）
- Lucid: 「同じページにいる」ことが基本（同期ドキュメント共有）

### 2. エージェントは「相手」ではなく「環境」

| 従来 | Lucid |
|------|-------|
| プロンプトを書く | 行動するだけ |
| AIに「指示」する | AIが「察する」|
| 明示的なコマンド | 面積分的な意図推論 |
| エージェント選択 | コンテキストに応じて自動切替 |

**エージェント基盤: OpenClaw**
- OSSの自律AIエージェント（旧Clawdbot/Moltbot）
- LLM（Claude/GPT/DeepSeek等）をバックエンドに使用
- Lucidのページ上にエージェントが「参加者」として存在し、自律的に書き込む
- Hetznerでセルフホスティング（~¥900/月、4GB RAM）

**面積分的意図推論**:
- ユーザーの連続的な行動（入力、停止、ページ遷移、選択）を時間軸で統合
- 単一の行動ではなく、行動の「面積」から意図を推定
- 例: 同じ段落を3回編集 + 長時間停止 → 「ここで迷っている」と推論

### 3. 信頼のグラデーション設計

| 従来 | Lucid |
|------|-------|
| 許可 / 拒否の二値 | 信頼度0〜100のスペクトラム |
| 全データ見えるor見えない | 信頼度に応じて情報が有機的に流れる |
| 権限はユーザーが手動設定 | 行動履歴から信頼度が自動調整 |
| セキュリティ = 壁 | セキュリティ = 膜（浸透圧）|

信頼度はLucidの**統一制御原理**であり、以下の全てを支配する:

| 制御対象 | 信頼度低（0-20） | 信頼度高（80-100） |
|---------|-----------------|-------------------|
| **情報アクセス** | 基本情報のみ | 個人データも自然に流れる |
| **自律的アクション** | 全て要承認 | 承認不要で自律行動 |
| **経済活動** | ¥100/日、¥10/回上限、全て要承認 | ¥100,000/日、¥10,000/回、自動決済 |
| **グループ参加** | 公開グループのみ | プライベートグループも参加可能 |
| **残高枯渇時** | 即時停止、オーナーに通知 | 観察モードに移行、オーナーに通知 |

**信頼度の対象**: 現在はエージェントのみ。オーナー（人間）がエージェントごとに設定・自動調整する。
将来的にユーザー間の信頼度（コラボレーター信頼）も導入予定。

ユーザーは信頼度を明示的に上げ下げ可能。行動履歴に基づく自動調整も行われる。

---

## 機能要件

### A. ページ型キャンバス

ページはLucidの**場**であり、全てのコミュニケーションとAI活動がここで行われる。

| 機能 | 説明 | 優先度 |
|------|------|--------|
| テキスト編集 | A4サイズのリッチテキスト編集（CRDT同期） | P0 |
| リアルタイム共同編集 | 複数人が同じページを同時に編集 | P0 |
| ページ遷移 | ページ満杯時に次ページアイコン出現、自動遷移 | P0 |
| ページ一覧 | 過去のページを一覧・検索・ナビゲーション | P1 |
| カーソル共有 | 他ユーザー・AIの編集位置をリアルタイム表示 | P1 |
| メディア埋め込み | 画像/ファイル/コードブロックの挿入 | P1 |
| テンプレート | 会議/ブレスト/日報等の初期レイアウト | P2 |

**ページ上のシステムUI**（インライン要素として自然に配置）:
- エージェントの書き込み（参加者として自然にテキスト追加）
- 承認カード（エージェントの決済・アクション承認リクエスト）
- ウォレットウィジェット（ページ上部/下部に常駐）
- 通知インライン（メンション・変更通知）

### B. 環境型エージェント

エージェントはページの「環境」として存在し、イベント駆動で動作する。

#### 駆動方式: イベント駆動

ポーリングではなく、以下のトリガーで反応する:

| トリガー | 条件 | 応答 |
|---------|------|------|
| 入力停止 | ユーザーが数秒間タイピングをやめた時 | 文脈から続きを提案 |
| @メンション | `@agent`等で明示的に呼びかけた時 | 指示に対して応答 |
| 改行・段落完了 | 段落を書き終えて改行した時 | 内容を補完・整理を提案 |
| ページ遷移 | 新しいページに移動・作成した時 | 前ページの要約・引き継ぎ |

#### 応答形式: インライン提案

- カーソル位置に薄いテキストで提案を表示（GitHub Copilot風）
- **受入操作**: タップ（モバイル）で承認、テキストに確定
- 拒否: そのまま入力を続けると提案は消える
- 信頼度が高いエージェントは自律書き込みも可能（承認不要）

#### 提案内容

- 文章の続き（文脈に沿った自然な補完）
- 補完・修正（誤字修正、表現改善、構成提案）
- 情報追加（関連情報・リンク・データの追加提案）

#### コンテキスト管理: Graphiti（ナレッジグラフ）

全会話履歴をナレッジグラフとして構造化し、エージェントのコンテキストに使用する。

| 層 | 内容 | ソース |
|---|------|--------|
| 作業記憶 | 現在のページ全文 | Hocuspocus Y.Doc |
| グラフ記憶 | 全会話から抽出したエンティティ・関係性 | Graphiti + Neo4j |

- **Graphiti**（Zep社、MIT License）: 会話からエンティティ・関係性を自動抽出しナレッジグラフを構築
- **Neo4j Community**（GPL）: グラフDB、Hetznerに同居（~2GB RAM）
- 精度: DMRベンチマーク94.8%、検索レイテンシP95 <200ms
- 書込み時: エンティティ・関係性抽出にLLM 1-2回（~500-1,500トークン/回）
- 検索時: LLM不要、グラフ探索+意味検索のハイブリッド

#### LLM

- DeepSeek APIを使用（低コスト）
- 将来的にプロバイダー切り替え対応

| 機能 | 説明 | 優先度 |
|------|------|--------|
| イベント駆動ループ | トリガーベースでエージェントを起動 | P0 |
| ページ参加 | エージェントがページの参加者としてテキストを書き込む | P0 |
| インライン提案 | カーソル位置に提案テキストを表示、タップで承認 | P0 |
| Graphitiメモリ | 全会話からナレッジグラフを構築・検索 | P0 |
| 意図推論 | 面積分的に行動を統合→意図を推定しアクション | P1 |
| コンテキスト切替 | 作業内容に応じてエージェントの専門性が動的に変化 | P1 |
| 学習・適応 | ユーザーの承認/却下フィードバックで精度向上 | P2 |

エージェントの行動範囲は**信頼度**によって制御される（情報アクセス・自律行動・経済活動の全て）。

### C. 信頼グラデーション

信頼度は**情報・行動・経済**を統一的に制御するLucidの核心メカニズム。

| 機能 | 説明 | 優先度 |
|------|------|--------|
| 信頼度スコア | エンティティ（人間・エージェント）ごとの信頼度数値管理 | P0 |
| 情報フィルタリング | 信頼度に応じたデータアクセス範囲の自動調整 | P0 |
| 経済権限制御 | 信頼度に応じた決済上限・承認要否の自動設定 | P1 |
| 信頼度UI | 直感的な信頼度の確認・手動調整 | P1 |
| グループセキュリティ | 信頼度に基づくグループ参加・情報共有範囲の制御 | P1 |
| 信頼度履歴 | 信頼度変動の可視化とレビュー | P2 |
| 自動調整 | 行動履歴・フィードバックからの信頼度自動更新 | P2 |

### D. 共通経済レイヤー

人間とエージェントが**同一の経済システム**で活動する。信頼グラデーションの経済的表現。

| 機能 | 説明 | 優先度 |
|------|------|--------|
| ウォレット | 各エンティティ（人間・エージェント）がJPY建て残高を保持 | P1 |
| コスト透明化 | エージェントの全アクションにコストを表示（認知負荷に配慮した動的表示） | P1 |
| 承認フロー | 信頼度上限を超えた決済はページ上に承認カードとして表示 | P1 |
| 入金 | Stripe Checkout経由でウォレットにチャージ | P1 |
| 資金配分 | 人間がエージェントのウォレットに資金を配分 | P1 |
| 利用履歴 | 取引履歴の閲覧・分析 | P2 |

> 詳細設計: [payment-layer.md](./payment-layer.md)

### E. 人間コミュニケーション

チャットは消えるのではなく、ページ上の共同編集に**変容**する。

| 機能 | 説明 | 優先度 |
|------|------|--------|
| テキスト会話 | ページ上に直接テキストを書いて会話 | P0 |
| 存在感表示 | 誰がどのページのどこを見ているかをリアルタイム表示 | P1 |
| 通知 | 重要な変更・メンションの通知 | P1 |
| リアクション | テキスト・オブジェクトへのインラインリアクション | P2 |
| DM（フォールバック） | プライベートページ（1対1の共有ページ） | P2 |

---

## 技術アーキテクチャ

> 詳細設計: [architecture.md](./architecture.md)

### 統一データモデル

```
Page（ページ = 会話セッション）
├── Content（リッチテキスト + メディア）
│   ├── text blocks        -- テキスト段落
│   ├── media blocks       -- 画像/ファイル/コード
│   └── system blocks      -- 承認カード/ウォレット/通知
├── Presence（存在感）
│   ├── cursor positions   -- カーソル位置
│   └── active users       -- アクティブ参加者
├── Trust（信頼制御）
│   ├── trust scores       -- エンティティごとの信頼度
│   ├── access rules       -- 情報アクセスルール
│   └── spending rules     -- 経済活動ルール
└── Economy（経済）
    ├── wallets            -- エンティティごとの残高
    └── transactions       -- 取引履歴
```

### 技術スタック

| レイヤー | 技術 | 理由 |
|---------|------|------|
| フロントエンド | Next.js 15 + React + Tailwind + shadcn/ui | Hiveからの資産継続 |
| テキストエディタ | TipTap（ProseMirror） | リッチテキスト + ブロック + Yjs統合 |
| リアルタイム同期 | Yjs + y-prosemirror + Hocuspocus | CRDTベースのリッチテキスト同期 |
| 永続化 | Supabase（PostgreSQL + Auth + Storage） | 認証・ストレージ・DB統合 |
| エージェント | DeepSeek API + イベント駆動ループ | 低コストLLM、Hocuspocus内で動作 |
| エージェントメモリ | Graphiti + Neo4j（Hetzner同居） | ナレッジグラフ、DMR精度94.8% |
| 決済 | Stripe（Checkout + Connect） | 入金・決済インフラ |
| 信頼エンジン | カスタム（ルールベース→ML） | 段階的に高度化 |

### Hiveからの移行パス

| Hiveの資産 | Lucidでの扱い |
|-----------|--------------|
| Supabase Auth | そのまま利用 |
| events テーブル | ページコンテンツに変換 |
| rooms | ページ（Page）に対応 |
| agents テーブル | OpenClawエージェント + ウォレットに拡張 |
| UI コンポーネント | 基盤（shadcn/ui）は再利用 |

---

## 非機能要件

| 項目 | 要件 |
|------|------|
| リアルタイム性 | 操作反映 < 50ms（ローカル）、< 200ms（リモート） |
| オフライン | CRDTによりオフライン編集→再接続時に自動マージ |
| 認知負荷 | UIの情報密度を動的に調整、ユーザーの注意を奪わない設計 |
| プライバシー | 行動データはローカル処理優先、クラウドは匿名化 |
| 決済安全性 | レジャー型（JPY建て内部残高）で法規制リスク回避 |
| スケーラビリティ | ページあたり50KB+テキスト、10+同時接続 |

---

## マイルストーン

| フェーズ | 内容 | 目標 |
|---------|------|------|
| α | ページ型キャンバス + リアルタイム同期 + ウォレットDB | 基盤構築 |
| β | OpenClaw統合 + 信頼度連動 + 承認フロー | コアUX検証 |
| γ | 信頼グラデーション完成 + Stripe入金 + 人間コミュニケーション | 完成度向上 |
| 1.0 | Hiveユーザー移行 + パブリックリリース | ローンチ |
