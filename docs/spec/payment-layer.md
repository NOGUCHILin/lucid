# 共通決済レイヤー設計

## 方式: レジャー型（法定通貨建て内部残高管理）

内部で「通貨」を発行せず、JPY建ての残高をレジャー（台帳）で管理する。
Stripe Connectで入出金を処理し、法規制リスクを回避する。

---

## データモデル

### エンティティ

```
Entity（人間・エージェント共通の基底）
├── User（人間）
│   ├── id: UUID
│   ├── stripe_customer_id: string
│   └── wallet_id: UUID
└── Agent（AI）
    ├── id: UUID
    ├── owner_id: UUID（作成者のUser）
    ├── trust_level: 0-100    -- オーナーが設定、行動履歴で自動調整
    ├── wallet_id: UUID
    └── status: enum          -- 'active' | 'paused'（残高枯渇時）
```

> **注**: trust_levelは現在エージェントのみに適用。
> ユーザー間信頼（コラボレーター信頼）は将来バージョンで導入予定。

### ウォレット

```sql
wallets
├── id: UUID
├── entity_id: UUID          -- User or Agent
├── entity_type: enum        -- 'user' | 'agent'
├── balance: decimal(12,2)   -- JPY建て残高
├── daily_spent: decimal(12,2) -- 当日の利用額
├── daily_limit: decimal(12,2) -- 当日の利用上限
└── updated_at: timestamp
```

### トランザクション

```sql
transactions
├── id: UUID
├── type: enum
│   ├── 'top_up'      -- 入金（Stripe → ウォレット）
│   ├── 'usage'       -- AI利用料（推論・API呼び出し）
│   ├── 'transfer'    -- エンティティ間送金
│   └── 'refund'      -- 返金
├── from_wallet_id: UUID (nullable)
├── to_wallet_id: UUID (nullable)
├── amount: decimal(12,2)
├── description: string
├── metadata: jsonb        -- 利用詳細（モデル名、トークン数等）
├── status: enum           -- 'pending' | 'completed' | 'failed'
├── approved_by: UUID      -- 人間承認が必要だった場合の承認者
└── created_at: timestamp
```

---

## 信頼度 × 決済ルール

信頼グラデーション（0-100）が決済の自律性を制御する。

| 信頼度 | 日次上限 | 1回あたり上限 | 承認 |
|--------|---------|-------------|------|
| 0-20（新規） | ¥100 | ¥10 | 全て要承認（回上限は承認時の安全キャップ） |
| 21-50（基本） | ¥1,000 | ¥100 | ¥50超は要承認 |
| 51-80（信頼） | ¥10,000 | ¥1,000 | ¥500超は要承認 |
| 81-100（完全信頼） | ¥100,000 | ¥10,000 | 承認不要 |

### 承認フロー

```
Agent決済リクエスト
  ↓
信頼度チェック → 上限内？ → Yes → 自動承認 → 実行
                    ↓ No
              キャンバスに承認カード表示
                    ↓
              人間が承認/却下
                    ↓
              承認 → 実行 / 却下 → キャンセル
```

**承認UIはキャンバス上に表示**される（ポップアップではなく、空間的にオブジェクトとして配置）。

### 残高枯渇時の挙動

エージェントのウォレット残高が0になった場合:

1. **即時**: エージェントのstatusを`paused`に変更
2. **通知**: キャンバス上にオーナーへの通知カードを表示（「エージェント名の残高が0になりました」）
3. **動作制限**: エージェントは**観察モード**に移行
   - 行動トラッキング・意図推論は継続（コスト0の処理）
   - 有料アクション（LLM推論・外部API等）は停止
   - キャンバスへの提案配置も停止
4. **復帰**: オーナーが資金を配分するとstatusが`active`に戻り、通常動作を再開

---

## Stripe Connect統合

### 入金フロー

```
User → Stripe Checkout → Stripe Webhook → balance加算
```

- Stripe Checkoutで金額を選択（¥500, ¥1,000, ¥5,000, ¥10,000）
- Webhook `checkout.session.completed` で残高加算
- トランザクション type='top_up' を記録

### エージェントへの資金配分

```
User Wallet ──transfer──→ Agent Wallet
```

- 人間がエージェントのウォレットに資金を配分
- 信頼度に応じたデフォルト配分の自動提案

### コスト計算（usage）

| リソース | 単価目安 |
|---------|---------|
| LLM推論（入力1Kトークン） | ¥0.3〜¥3 |
| LLM推論（出力1Kトークン） | ¥1〜¥15 |
| 画像生成（1枚） | ¥5〜¥50 |
| 外部API呼び出し | パススルー |

---

## キャンバス上のUI

### ウォレットウィジェット

キャンバスの隅に常駐する小さなウィジェット:
- 現在の残高表示
- 今日の利用額 / 上限のプログレスバー
- タップで詳細展開（取引履歴）

### 承認カード

エージェントが上限超えの決済をリクエストした時:
- キャンバス上に「承認カード」オブジェクトが出現
- 内容: エージェント名、金額、理由、承認/却下ボタン
- 放置すると自動キャンセル（タイムアウト設定可能）

### コスト可視化

エージェントのアクションにコストが発生する時:
- アクション近くに小さなコスト表示（¥3）
- 高コストなアクションほど表示が大きい（認知負荷の動的調整）

---

## 実装フェーズ

| フェーズ | 内容 | 依存 |
|---------|------|------|
| α（キャンバスと同時） | ウォレットDB + 残高管理API | Supabase |
| β（エージェントと同時） | 信頼度連動 + 承認フロー | 信頼グラデーション |
| γ | Stripe Connect入金 + コスト可視化UI | Stripe |
| 1.0 | 取引履歴 + 分析ダッシュボード | - |
